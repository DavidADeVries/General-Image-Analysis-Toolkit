function [] = dicomDownloadCleanup(rawDataPath, newDataPath)

dirList = dir(rawDataPath);

for i=1:length(dirList)
    entry = dirList(1);
    name = entry.name;
    
    if entry.isdir && ~(strcmp(name,'.') || strcmp(name,'..'))
        if ~isempty(strfind(name, 'download')) %is a download folder
            [patientName, oldPatientDir] = createPatient(strcat(rawDataPath,'/',name));
            
            newName = strcat(rawDataPath, '/', cleanString(patientName));
            
            patientAlreadyExists = 
            
            movefile(oldPatientDir, newName);
            
            rmdir(strcat(rawDataPath,'/',name));
        end            
    end
end











end

function [patientName, oldPatientDir] = createPatient(downloadPath)

    dirList = dir(downloadPath);

    patientFolder = '';

    if length(dirList) == 3
        for i=1:length(dirList)
            entry = dirList(i);
            name = entry.name;

            if entry.isdir && ~(strcmp(name, '..') || strcmp(name, '.'))
                patientFolder = name;
            end
        end

        patientName = createStudies(strcat(downloadPath, '/', patientFolder));
        
        oldPatientDir = strcat(downloadPath, '/', patientFolder);
        
    elseif isempty(dirList)
        warning('Directory does not exist!');
    else
        warning('Imcompatible Folder! Should only contain a single patient!');
    end
end

function patientName = createStudies(patientPath)
% [studies, patientId] = createStudies(folderPath)
% creates a list of studies based upon the path given. Each directory at
% the path given will be considered a study, each containing directories of
% studies, which in turn contain .dcm (DICOM) files
% also returns the patientId of the DICOM files
dirList = dir(patientPath);

patientName = '';

studyCounter = 1;

dateFormat = 'mm-dd-yyyy'; %DO NOT PUT /'s in this! Is used in folder name!
dummyTime = cdfepoch(datestr(1,0,0)); %Jan 1, 000

for i=1:length(dirList)
    entry = dirList(i);
    studyFolder = entry.name;
    
    if entry.isdir && ~(strcmp(studyFolder, '..') || strcmp(studyFolder, '.'))
        
        [patientName, studyDescription, studyTime] = createSeries(strcat(patientPath,'/', studyFolder), patientName);
        
        if ~isempty(studyDescription)
            if isempty(studyTime)
                studyTime = dummyTime;
            end
            
            dateNum = todatenum(studyTime);
            
            if dateNum == 1
                studyTimeString = 'No Date';
            else
                studyTimeString = datestr(dateNum, dateFormat);
            end
            
            studies(studyCounter) = struct('folder', studyFolder, 'studyDescription', studyDescription, 'studyTimeString', studyTimeString, 'sort', dateNum);
            studyCounter = studyCounter + 1;
        end
    end
end

%sort studies struct array so that they can be renamed in order
studiesCell = struct2cell(studies);
dims = size(studiesCell);

studiesCell = reshape(studiesCell, dims(1), [])';
sortedStudiesCell = sortrows(studiesCell, 4); %sort on date, column 4

sortedStudiesCell = reshape(sortedStudiesCell', dims);

sortedStudies = cell2struct(sortedStudiesCell, fieldnames(studies), 1);



for i=1:length(sortedStudies)
    study = sortedStudies(i);
    
    numDuplicates = checkForDuplicates(sortedStudies, i);
    
    if numDuplicates == 0
        uniqueEnd = '';
    else
        uniqueEnd = [' (',num2str(numDuplicates+1),')'];
    end
    
    oldName = [patientPath, '/', study.folder];
    newName = [patientPath, '/', study.studyTimeString, ' - ', cleanString(study.studyDescription), uniqueEnd];
    
    if ~strcmp(oldName, newName)
        movefile(oldName, newName);
    end
end

end

function [patientName, studyDescription, studyTime] = createSeries(studyPath, patientName)

dirList = dir(studyPath);

studyDescription = '';
studyTime = '';

seriesFolderNames = cell(0);
numSeries = 0;

for i=1:length(dirList)
    entry = dirList(i);
    seriesFolder = entry.name;
    
    if entry.isdir && ~(strcmp(seriesFolder, '..') || strcmp(seriesFolder, '.'))
        [patientName, studyDescription, studyTime, seriesNumber, seriesDescription] = createFiles(strcat(studyPath,'/', seriesFolder), patientName, studyDescription, studyTime);
        
        if isempty(seriesDescription)
            seriesDescription = 'No Description';
        end
        
        if isempty(seriesNumber)
            seriesNumberString = '####';
        else
            seriesNumberString = padWithZeros(seriesNumber, 4);
        end
        
        seriesFolderName = [seriesNumberString, ' - ', cleanString(seriesDescription)];
        
        numDuplicates = checkForSeriesDuplicates(seriesFolderNames, seriesFolderName);
        
        if numDuplicates == 0
            uniqueEnd = '';
        else
            uniqueEnd = [' (', num2str(numDuplicates + 1), ')'];
        end
        
        numSeries = numSeries + 1;
        
        seriesFolderNames{numSeries} = seriesFolderName;
            
        
        oldName = [studyPath, '/', seriesFolder];
        newName = [studyPath, '/', seriesFolderName, uniqueEnd];
        
        if ~strcmp(oldName, newName)            
            movefile(oldName, newName);
        end
    end
end

end

function [patientName, studyDescription, studyTime, seriesNumber, seriesDescription] = createFiles(seriesPath, patientName, studyDescription, studyTime)



dirList = dir(seriesPath);

seriesDescription = '';
seriesNumber = 0;

newFileNames = cell(0);
numNewFiles = 0;

for i=1:length(dirList)
    entry = dirList(i);
    fileName = entry.name;
    
    
    if entry.isdir 
        if ~(strcmp(fileName, '..') || strcmp(fileName, '.')) % another directory is present, rare but can happen
            error(['Directory found when expecting DICOMs at: ', seriesPath, '/', fileName]);
%             subDirList = dir(strcat(seriesPath, '/', fileName));
%             
%             for j=1:length(subDirList)
%                 subEntry = subDirList(j);
%                 subFileName = subEntry.name;
%                 
%                 if subEntry.isdir 
%                     if ~(strcmp(subFileName, '..') || strcmp(subFileName, '.')) %another directory!!! ENOUGH!! PUNISH THEM!!
%                         error(['Directory found when expecting DICOMs at: ', seriesPath, '/', fileName, '/', subFileName]);
%                     end
%                 else
%                     len = length(subFileName);
%                     fileType = subFileName(len-2:len);
%                     
%                     if strcmp(fileType, 'dcm') %import this bad boy
%                         dicomHeader = dicominfo(strcat(seriesPath,'/',fileName,'/',subFileName));
%                         [patientName, studyDescription, studyTime, seriesNumber, seriesDescription] = extractHeaderInfo(dicomHeader, patientName, studyDescription, studyTime, seriesNumber, seriesDescription);
%                         instanceNumber = padWithZeros(dicomHeader.InstanceNumber, 4);
%                         
%                         oldName = strcat(seriesPath,'/',fileName,'/',subFileName);
%                         newName = [seriesPath,'/',instanceNumber,' - ',fileName,'.dcm'];
%                         
%                         if ~strcmp(oldName, newName)
%                             movefile(oldName, newName);
%                         end
%                     else
%                         warning(['Non DICOM file found at: ', seriesPath, '/', fileName, '/', subFileName]);
%                     end
%                 end
%             end
%             
%             % all files in this directory are now moved out, so delete it
%             rmdir(strcat(seriesPath,'/',fileName));
        end
        
        
    else
        len = length(fileName);
        fileType = fileName(len-2:len);
        
        if strcmp(fileType, 'dcm') %import this bad boy
            dicomHeader = dicominfo(strcat(seriesPath,'/',fileName));
            [patientName, studyDescription, studyTime, seriesNumber, seriesDescription] = extractHeaderInfo(dicomHeader, patientName, studyDescription, studyTime, seriesNumber, seriesDescription);
            
            if isfield(dicomHeader, 'InstanceNumber')            
                newFileName = padWithZeros(dicomHeader.InstanceNumber, 4);
            else
                newFileName = '####';
            end            
                    
            numDuplicates = checkForSeriesDuplicates(newFileNames, newFileName);
            
            if numDuplicates == 0
                uniqueEnd = '';
            else
                uniqueEnd = [' (', num2str(numDuplicates + 1), ')'];
            end
            
            numNewFiles = numNewFiles + 1;
            
            newFileNames{numNewFiles} = newFileName;
            
            
            oldName = strcat(seriesPath,'/', fileName);
            newName = strcat(seriesPath,'/', newFileName, uniqueEnd,'.dcm');
            
            if ~strcmp(oldName, newName)
                movefile(oldName, newName);
            end
        else
            warning(['Non DICOM file found at: ', seriesPath, '/', fileName]);
        end
    end
    
end
end

function str = cleanString(str)
    str = strrep(str, '/', '-');
    str = strrep(str, '\', '-');
end

function str = padWithZeros(num, targetLength)
    baseStr = num2str(num);
    
    len = length(baseStr);
    
    if len <= targetLength
        prefix = '';
        
        for i=len:targetLength-1
            prefix = [prefix, '0'];
        end
        
        str = [prefix, baseStr];
    else
        warning([baseStr, ' is too long for a target length of ', num2str(targetLength)]);
        
        str = baseStr;
    end
end

function epoch = dateAndTimeToEpoch(dateString, timeString)
    yearString = dateString(1:4);
    monthString = dateString(5:6);
    dayString = dateString(7:8);
    
    if isempty(timeString)
        hourString = '0';
        minuteString = '00';    
    elseif mod(length(timeString), 2) == 0 %even length, hour is double digit
        hourString = timeString(1:2);
        minuteString = timeString(3:4);
    else %odd length, hour is single digit
        hourString = timeString(1);
        minuteString = timeString(2:3);
    end

    dateString = datestr([str2num(yearString), str2num(monthString), str2num(dayString), str2num(hourString), str2num(minuteString), 0]);
    epoch = cdfepoch(dateString);
end

function [patientName, studyDescription, studyTime, seriesNumber, seriesDescription] = extractHeaderInfo(dicomHeader, patientName, studyDescription, studyTime, seriesNumber, seriesDescription)

    if isempty(patientName)
        patientName = dicomHeader.PatientName.FamilyName;
    end

    if isempty(studyDescription)
        studyDescription = dicomHeader.StudyDescription;
    end
    
    dicomStudyTime = dateAndTimeToEpoch(dicomHeader.StudyDate, dicomHeader.StudyTime);
    
    if isempty(studyTime)
        studyTime = dicomStudyTime;
    end

    if isfield(dicomHeader, 'SeriesDescription')
        dicomSeriesDescription = dicomHeader.SeriesDescription;
    else
        dicomSeriesDescription = 'No Description';
    end

    if isempty(seriesDescription)
        seriesDescription = dicomSeriesDescription;
    end

    if isfield(dicomHeader, 'SeriesNumber')
        dicomSeriesNumber = dicomHeader.SeriesNumber;
    else
        dicomSeriesNumber = '';
    end

    if seriesNumber == 0
        seriesNumber = dicomSeriesNumber;
    end

    if ~(strcmp(patientName, dicomHeader.PatientName.FamilyName))
        warning('PatientName mismatch!');
    end

    if ~(strcmp(studyDescription, dicomHeader.StudyDescription))
        %warning('StudyDescription mismatch!');
    end

    if ~(strcmp(studyTime, dicomStudyTime))
        %warning('StudyTime mismatch!');
    end

    if ~(strcmp(seriesDescription, dicomSeriesDescription))
        %warning('SeriesDescription mismatch!');
    end

    if seriesNumber ~= dicomSeriesNumber
        %warning('SeriesNumber mismatch!');
    end

end

function numDuplicates = checkForDuplicates(sortedStudies, i)
% since sortedStudies is sorted, only backtrack, looking to see how many so
% far would have been made

masterStudy = sortedStudies(i);

numDuplicates = 0;

i=i-1; %start backtracking

while i > 0
    prevStudy = sortedStudies(i);
    
    if strcmp(prevStudy.studyTimeString, masterStudy.studyTimeString) && strcmp(prevStudy.studyDescription, masterStudy.studyDescription)
        numDuplicates = numDuplicates + 1;
    elseif ~strcmp(prevStudy.studyTimeString, masterStudy.studyTimeString)
        break; % no need to search further
    end
    
    i = i-1;
end

end

function numDuplicates = checkForSeriesDuplicates(seriesFolderNames, matchName)
    numDuplicates = 0;
    
    for i=1:length(seriesFolderNames)
        if strcmp(seriesFolderNames{i}, matchName)
            numDuplicates = numDuplicates + 1;
        end
    end
end